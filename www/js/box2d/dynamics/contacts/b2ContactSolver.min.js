var b2ContactSolver=Class.create();b2ContactSolver.prototype={initialize:function(o,n,t){this.m_constraints=new Array,this.m_allocator=t;var a,i,l=0;for(this.m_constraintCount=0,l=0;n>l;++l)this.m_constraintCount+=o[l].GetManifoldCount();for(l=0;l<this.m_constraintCount;l++)this.m_constraints[l]=new b2ContactConstraint;var r=0;for(l=0;n>l;++l)for(var s=o[l],m=s.m_shape1.m_body,e=s.m_shape2.m_body,c=s.GetManifoldCount(),y=s.GetManifolds(),_=s.m_friction,p=s.m_restitution,v=m.m_linearVelocity.x,u=m.m_linearVelocity.y,x=e.m_linearVelocity.x,I=e.m_linearVelocity.y,b=m.m_angularVelocity,h=e.m_angularVelocity,f=0;c>f;++f){var C=y[f],M=C.normal.x,g=C.normal.y,V=this.m_constraints[r];V.body1=m,V.body2=e,V.manifold=C,V.normal.x=M,V.normal.y=g,V.pointCount=C.pointCount,V.friction=_,V.restitution=p;for(var d=0;d<V.pointCount;++d){var S=C.points[d],A=V.points[d];A.normalImpulse=S.normalImpulse,A.tangentImpulse=S.tangentImpulse,A.separation=S.separation;var R=S.position.x-m.m_position.x,B=S.position.y-m.m_position.y,w=S.position.x-e.m_position.x,G=S.position.y-e.m_position.y;a=A.localAnchor1,i=m.m_R,a.x=R*i.col1.x+B*i.col1.y,a.y=R*i.col2.x+B*i.col2.y,a=A.localAnchor2,i=e.m_R,a.x=w*i.col1.x+G*i.col1.y,a.y=w*i.col2.x+G*i.col2.y;var P=R*R+B*B,W=w*w+G*G,z=R*M+B*g,L=w*M+G*g,T=m.m_invMass+e.m_invMass;T+=m.m_invI*(P-z*z)+e.m_invI*(W-L*L),A.normalMass=1/T;var j=g,k=-M,q=R*j+B*k,D=w*j+G*k,E=m.m_invMass+e.m_invMass;E+=m.m_invI*(P-q*q)+e.m_invI*(W-D*D),A.tangentMass=1/E,A.velocityBias=0,A.separation>0&&(A.velocityBias=-60*A.separation);var F=x+-h*G-v- -b*B,H=I+h*w-u-b*R,J=V.normal.x*F+V.normal.y*H;J<-b2Settings.b2_velocityThreshold&&(A.velocityBias+=-V.restitution*J)}++r}},PreSolve:function(){for(var o,n,t=0;t<this.m_constraintCount;++t){var a=this.m_constraints[t],i=a.body1,l=a.body2,r=i.m_invMass,s=i.m_invI,m=l.m_invMass,e=l.m_invI,c=a.normal.x,y=a.normal.y,_=y,p=-c,v=0,u=0;if(b2World.s_enableWarmStarting)for(u=a.pointCount,v=0;u>v;++v){var x=a.points[v],I=x.normalImpulse*c+x.tangentImpulse*_,b=x.normalImpulse*y+x.tangentImpulse*p;n=i.m_R,o=x.localAnchor1;var h=n.col1.x*o.x+n.col2.x*o.y,f=n.col1.y*o.x+n.col2.y*o.y;n=l.m_R,o=x.localAnchor2;var C=n.col1.x*o.x+n.col2.x*o.y,M=n.col1.y*o.x+n.col2.y*o.y;i.m_angularVelocity-=s*(h*b-f*I),i.m_linearVelocity.x-=r*I,i.m_linearVelocity.y-=r*b,l.m_angularVelocity+=e*(C*b-M*I),l.m_linearVelocity.x+=m*I,l.m_linearVelocity.y+=m*b,x.positionImpulse=0}else for(u=a.pointCount,v=0;u>v;++v){var g=a.points[v];g.normalImpulse=0,g.tangentImpulse=0,g.positionImpulse=0}}},SolveVelocityConstraints:function(){for(var o,n,t,a,i,l,r,s,m,e,c,y,_,p=0,v=0;v<this.m_constraintCount;++v){var u=this.m_constraints[v],x=u.body1,I=u.body2,b=x.m_angularVelocity,h=x.m_linearVelocity,f=I.m_angularVelocity,C=I.m_linearVelocity,M=x.m_invMass,g=x.m_invI,V=I.m_invMass,d=I.m_invI,S=u.normal.x,A=u.normal.y,R=A,B=-S,w=u.pointCount;for(p=0;w>p;++p){o=u.points[p],y=x.m_R,_=o.localAnchor1,n=y.col1.x*_.x+y.col2.x*_.y,t=y.col1.y*_.x+y.col2.y*_.y,y=I.m_R,_=o.localAnchor2,a=y.col1.x*_.x+y.col2.x*_.y,i=y.col1.y*_.x+y.col2.y*_.y,l=C.x+-f*i-h.x- -b*t,r=C.y+f*a-h.y-b*n;var G=l*S+r*A;s=-o.normalMass*(G-o.velocityBias),m=b2Math.b2Max(o.normalImpulse+s,0),s=m-o.normalImpulse,e=s*S,c=s*A,h.x-=M*e,h.y-=M*c,b-=g*(n*c-t*e),C.x+=V*e,C.y+=V*c,f+=d*(a*c-i*e),o.normalImpulse=m,l=C.x+-f*i-h.x- -b*t,r=C.y+f*a-h.y-b*n;var P=l*R+r*B;s=o.tangentMass*-P;var W=u.friction*o.normalImpulse;m=b2Math.b2Clamp(o.tangentImpulse+s,-W,W),s=m-o.tangentImpulse,e=s*R,c=s*B,h.x-=M*e,h.y-=M*c,b-=g*(n*c-t*e),C.x+=V*e,C.y+=V*c,f+=d*(a*c-i*e),o.tangentImpulse=m}x.m_angularVelocity=b,I.m_angularVelocity=f}},SolvePositionConstraints:function(o){for(var n,t,a=0,i=0;i<this.m_constraintCount;++i){for(var l=this.m_constraints[i],r=l.body1,s=l.body2,m=r.m_position,e=r.m_rotation,c=s.m_position,y=s.m_rotation,_=r.m_invMass,p=r.m_invI,v=s.m_invMass,u=s.m_invI,x=l.normal.x,I=l.normal.y,b=l.pointCount,h=0;b>h;++h){var f=l.points[h];n=r.m_R,t=f.localAnchor1;var C=n.col1.x*t.x+n.col2.x*t.y,M=n.col1.y*t.x+n.col2.y*t.y;n=s.m_R,t=f.localAnchor2;var g=n.col1.x*t.x+n.col2.x*t.y,V=n.col1.y*t.x+n.col2.y*t.y,d=m.x+C,S=m.y+M,A=c.x+g,R=c.y+V,B=A-d,w=R-S,G=B*x+w*I+f.separation;a=b2Math.b2Min(a,G);var P=o*b2Math.b2Clamp(G+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),W=-f.normalMass*P,z=f.positionImpulse;f.positionImpulse=b2Math.b2Max(z+W,0),W=f.positionImpulse-z;var L=W*x,T=W*I;m.x-=_*L,m.y-=_*T,e-=p*(C*T-M*L),r.m_R.Set(e),c.x+=v*L,c.y+=v*T,y+=u*(g*T-V*L),s.m_R.Set(y)}r.m_rotation=e,s.m_rotation=y}return a>=-b2Settings.b2_linearSlop},PostSolve:function(){for(var o=0;o<this.m_constraintCount;++o)for(var n=this.m_constraints[o],t=n.manifold,a=0;a<n.pointCount;++a){var i=t.points[a],l=n.points[a];i.normalImpulse=l.normalImpulse,i.tangentImpulse=l.tangentImpulse}},m_allocator:null,m_constraints:new Array,m_constraintCount:0};