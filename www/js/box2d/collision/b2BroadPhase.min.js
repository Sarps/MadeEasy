var b2BroadPhase=Class.create();b2BroadPhase.prototype={initialize:function(r,t){this.m_pairManager=new b2PairManager,this.m_proxyPool=new Array(b2Settings.b2_maxPairs),this.m_bounds=new Array(2*b2Settings.b2_maxProxies),this.m_queryResults=new Array(b2Settings.b2_maxProxies),this.m_quantizationFactor=new b2Vec2;var e=0;for(this.m_pairManager.Initialize(this,t),this.m_worldAABB=r,this.m_proxyCount=0,e=0;e<b2Settings.b2_maxProxies;e++)this.m_queryResults[e]=0;for(this.m_bounds=new Array(2),e=0;2>e;e++){this.m_bounds[e]=new Array(2*b2Settings.b2_maxProxies);for(var o=0;o<2*b2Settings.b2_maxProxies;o++)this.m_bounds[e][o]=new b2Bound}var a=r.maxVertex.x,n=r.maxVertex.y;a-=r.minVertex.x,n-=r.minVertex.y,this.m_quantizationFactor.x=b2Settings.USHRT_MAX/a,this.m_quantizationFactor.y=b2Settings.USHRT_MAX/n;var i;for(e=0;e<b2Settings.b2_maxProxies-1;++e)i=new b2Proxy,this.m_proxyPool[e]=i,i.SetNext(e+1),i.timeStamp=0,i.overlapCount=b2BroadPhase.b2_invalid,i.userData=null;i=new b2Proxy,this.m_proxyPool[b2Settings.b2_maxProxies-1]=i,i.SetNext(b2Pair.b2_nullProxy),i.timeStamp=0,i.overlapCount=b2BroadPhase.b2_invalid,i.userData=null,this.m_freeProxy=0,this.m_timeStamp=1,this.m_queryResultCount=0},InRange:function(r){var t,e,o,a;return t=r.minVertex.x,e=r.minVertex.y,t-=this.m_worldAABB.maxVertex.x,e-=this.m_worldAABB.maxVertex.y,o=this.m_worldAABB.minVertex.x,a=this.m_worldAABB.minVertex.y,o-=r.maxVertex.x,a-=r.maxVertex.y,t=b2Math.b2Max(t,o),e=b2Math.b2Max(e,a),b2Math.b2Max(t,e)<0},GetProxy:function(r){return r==b2Pair.b2_nullProxy||0==this.m_proxyPool[r].IsValid()?null:this.m_proxyPool[r]},CreateProxy:function(r,t){var e,o=0,a=this.m_freeProxy;e=this.m_proxyPool[a],this.m_freeProxy=e.GetNext(),e.overlapCount=0,e.userData=t;var n=2*this.m_proxyCount,i=new Array,s=new Array;this.ComputeBounds(i,s,r);for(var u=0;2>u;++u){var m=this.m_bounds[u],b=0,l=0,x=[b],p=[l];this.Query(x,p,i[u],s[u],m,n,u),b=x[0],l=p[0];var h,d,_=new Array,y=0,v=n-l;for(y=0;v>y;y++)_[y]=new b2Bound,h=_[y],d=m[l+y],h.value=d.value,h.proxyId=d.proxyId,h.stabbingCount=d.stabbingCount;v=_.length;var B=l+2;for(y=0;v>y;y++)d=_[y],h=m[B+y],h.value=d.value,h.proxyId=d.proxyId,h.stabbingCount=d.stabbingCount;for(_=new Array,v=l-b,y=0;v>y;y++)_[y]=new b2Bound,h=_[y],d=m[b+y],h.value=d.value,h.proxyId=d.proxyId,h.stabbingCount=d.stabbingCount;for(v=_.length,B=b+1,y=0;v>y;y++)d=_[y],h=m[B+y],h.value=d.value,h.proxyId=d.proxyId,h.stabbingCount=d.stabbingCount;for(++l,m[b].value=i[u],m[b].proxyId=a,m[l].value=s[u],m[l].proxyId=a,m[b].stabbingCount=0==b?0:m[b-1].stabbingCount,m[l].stabbingCount=m[l-1].stabbingCount,o=b;l>o;++o)m[o].stabbingCount++;for(o=b;n+2>o;++o){var f=this.m_proxyPool[m[o].proxyId];m[o].IsLower()?f.lowerBounds[u]=o:f.upperBounds[u]=o}}++this.m_proxyCount;for(var w=0;w<this.m_queryResultCount;++w)this.m_pairManager.AddBufferedPair(a,this.m_queryResults[w]);return this.m_pairManager.Commit(),this.m_queryResultCount=0,this.IncrementTimeStamp(),a},DestroyProxy:function(r){for(var t=this.m_proxyPool[r],e=2*this.m_proxyCount,o=0;2>o;++o){var a,n,i=this.m_bounds[o],s=t.lowerBounds[o],u=t.upperBounds[o],m=i[s].value,b=i[u].value,l=new Array,x=0,p=u-s-1;for(x=0;p>x;x++)l[x]=new b2Bound,a=l[x],n=i[s+1+x],a.value=n.value,a.proxyId=n.proxyId,a.stabbingCount=n.stabbingCount;p=l.length;var h=s;for(x=0;p>x;x++)n=l[x],a=i[h+x],a.value=n.value,a.proxyId=n.proxyId,a.stabbingCount=n.stabbingCount;for(l=new Array,p=e-u-1,x=0;p>x;x++)l[x]=new b2Bound,a=l[x],n=i[u+1+x],a.value=n.value,a.proxyId=n.proxyId,a.stabbingCount=n.stabbingCount;for(p=l.length,h=u-1,x=0;p>x;x++)n=l[x],a=i[h+x],a.value=n.value,a.proxyId=n.proxyId,a.stabbingCount=n.stabbingCount;p=e-2;for(var d=s;p>d;++d){var _=this.m_proxyPool[i[d].proxyId];i[d].IsLower()?_.lowerBounds[o]=d:_.upperBounds[o]=d}p=u-1;for(var y=s;p>y;++y)i[y].stabbingCount--;this.Query([0],[0],m,b,i,e-2,o)}for(var v=0;v<this.m_queryResultCount;++v)this.m_pairManager.RemoveBufferedPair(r,this.m_queryResults[v]);this.m_pairManager.Commit(),this.m_queryResultCount=0,this.IncrementTimeStamp(),t.userData=null,t.overlapCount=b2BroadPhase.b2_invalid,t.lowerBounds[0]=b2BroadPhase.b2_invalid,t.lowerBounds[1]=b2BroadPhase.b2_invalid,t.upperBounds[0]=b2BroadPhase.b2_invalid,t.upperBounds[1]=b2BroadPhase.b2_invalid,t.SetNext(this.m_freeProxy),this.m_freeProxy=r,--this.m_proxyCount},MoveProxy:function(r,t){var e,o,a,n,i=0,s=0,u=0;if(!(r==b2Pair.b2_nullProxy||b2Settings.b2_maxProxies<=r)&&0!=t.IsValid()){var m=2*this.m_proxyCount,b=this.m_proxyPool[r],l=new b2BoundValues;this.ComputeBounds(l.lowerValues,l.upperValues,t);var x=new b2BoundValues;for(i=0;2>i;++i)x.lowerValues[i]=this.m_bounds[i][b.lowerBounds[i]].value,x.upperValues[i]=this.m_bounds[i][b.upperBounds[i]].value;for(i=0;2>i;++i){var p=this.m_bounds[i],h=b.lowerBounds[i],d=b.upperBounds[i],_=l.lowerValues[i],y=l.upperValues[i],v=_-p[h].value,B=y-p[d].value;if(p[h].value=_,p[d].value=y,0>v)for(s=h;s>0&&_<p[s-1].value;){e=p[s],o=p[s-1];var f=o.proxyId,w=this.m_proxyPool[o.proxyId];o.stabbingCount++,1==o.IsUpper()?(this.TestOverlap(l,w)&&this.m_pairManager.AddBufferedPair(r,f),w.upperBounds[i]++,e.stabbingCount++):(w.lowerBounds[i]++,e.stabbingCount--),b.lowerBounds[i]--,e.Swap(o),--s}if(B>0)for(s=d;m-1>s&&p[s+1].value<=y;)e=p[s],a=p[s+1],u=a.proxyId,n=this.m_proxyPool[u],a.stabbingCount++,1==a.IsLower()?(this.TestOverlap(l,n)&&this.m_pairManager.AddBufferedPair(r,u),n.lowerBounds[i]--,e.stabbingCount++):(n.upperBounds[i]--,e.stabbingCount--),b.upperBounds[i]++,e.Swap(a),s++;if(v>0)for(s=h;m-1>s&&p[s+1].value<=_;)e=p[s],a=p[s+1],u=a.proxyId,n=this.m_proxyPool[u],a.stabbingCount--,a.IsUpper()?(this.TestOverlap(x,n)&&this.m_pairManager.RemoveBufferedPair(r,u),n.upperBounds[i]--,e.stabbingCount--):(n.lowerBounds[i]--,e.stabbingCount++),b.lowerBounds[i]++,e.Swap(a),s++;if(0>B)for(s=d;s>0&&y<p[s-1].value;)e=p[s],o=p[s-1],f=o.proxyId,w=this.m_proxyPool[f],o.stabbingCount--,1==o.IsLower()?(this.TestOverlap(x,w)&&this.m_pairManager.RemoveBufferedPair(r,f),w.lowerBounds[i]++,e.stabbingCount--):(w.upperBounds[i]++,e.stabbingCount++),b.upperBounds[i]--,e.Swap(o),s--}}},Commit:function(){this.m_pairManager.Commit()},QueryAABB:function(r,t,e){var o=new Array,a=new Array;this.ComputeBounds(o,a,r);var n=0,i=0,s=[n],u=[i];this.Query(s,u,o[0],a[0],this.m_bounds[0],2*this.m_proxyCount,0),this.Query(s,u,o[1],a[1],this.m_bounds[1],2*this.m_proxyCount,1);for(var m=0,b=0;b<this.m_queryResultCount&&e>m;++b,++m){var l=this.m_proxyPool[this.m_queryResults[b]];t[b]=l.userData}return this.m_queryResultCount=0,this.IncrementTimeStamp(),m},Validate:function(){for(var r=0;2>r;++r)for(var t=this.m_bounds[r],e=2*this.m_proxyCount,o=0,a=0;e>a;++a){var n=t[a];1==n.IsLower()?o++:o--}},ComputeBounds:function(r,t,e){var o=e.minVertex.x,a=e.minVertex.y;o=b2Math.b2Min(o,this.m_worldAABB.maxVertex.x),a=b2Math.b2Min(a,this.m_worldAABB.maxVertex.y),o=b2Math.b2Max(o,this.m_worldAABB.minVertex.x),a=b2Math.b2Max(a,this.m_worldAABB.minVertex.y);var n=e.maxVertex.x,i=e.maxVertex.y;n=b2Math.b2Min(n,this.m_worldAABB.maxVertex.x),i=b2Math.b2Min(i,this.m_worldAABB.maxVertex.y),n=b2Math.b2Max(n,this.m_worldAABB.minVertex.x),i=b2Math.b2Max(i,this.m_worldAABB.minVertex.y),r[0]=this.m_quantizationFactor.x*(o-this.m_worldAABB.minVertex.x)&b2Settings.USHRT_MAX-1,t[0]=this.m_quantizationFactor.x*(n-this.m_worldAABB.minVertex.x)&65535|1,r[1]=this.m_quantizationFactor.y*(a-this.m_worldAABB.minVertex.y)&b2Settings.USHRT_MAX-1,t[1]=this.m_quantizationFactor.y*(i-this.m_worldAABB.minVertex.y)&65535|1},TestOverlapValidate:function(r,t){for(var e=0;2>e;++e){var o=this.m_bounds[e];if(o[r.lowerBounds[e]].value>o[t.upperBounds[e]].value)return!1;if(o[r.upperBounds[e]].value<o[t.lowerBounds[e]].value)return!1}return!0},TestOverlap:function(r,t){for(var e=0;2>e;++e){var o=this.m_bounds[e];if(r.lowerValues[e]>o[t.upperBounds[e]].value)return!1;if(r.upperValues[e]<o[t.lowerBounds[e]].value)return!1}return!0},Query:function(r,t,e,o,a,n,i){for(var s=b2BroadPhase.BinarySearch(a,n,e),u=b2BroadPhase.BinarySearch(a,n,o),m=s;u>m;++m)a[m].IsLower()&&this.IncrementOverlapCount(a[m].proxyId);if(s>0)for(var b=s-1,l=a[b].stabbingCount;l;){if(a[b].IsLower()){var x=this.m_proxyPool[a[b].proxyId];s<=x.upperBounds[i]&&(this.IncrementOverlapCount(a[b].proxyId),--l)}--b}r[0]=s,t[0]=u},IncrementOverlapCount:function(r){var t=this.m_proxyPool[r];t.timeStamp<this.m_timeStamp?(t.timeStamp=this.m_timeStamp,t.overlapCount=1):(t.overlapCount=2,this.m_queryResults[this.m_queryResultCount]=r,++this.m_queryResultCount)},IncrementTimeStamp:function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var r=0;r<b2Settings.b2_maxProxies;++r)this.m_proxyPool[r].timeStamp=0;this.m_timeStamp=1}else++this.m_timeStamp},m_pairManager:new b2PairManager,m_proxyPool:new Array(b2Settings.b2_maxPairs),m_freeProxy:0,m_bounds:new Array(2*b2Settings.b2_maxProxies),m_queryResults:new Array(b2Settings.b2_maxProxies),m_queryResultCount:0,m_worldAABB:null,m_quantizationFactor:new b2Vec2,m_proxyCount:0,m_timeStamp:0},b2BroadPhase.s_validate=!1,b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX,b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX,b2BroadPhase.BinarySearch=function(r,t,e){for(var o=0,a=t-1;a>=o;){var n=Math.floor((o+a)/2);if(r[n].value>e)a=n-1;else{if(!(r[n].value<e))return n;o=n+1}}return o};